<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EOD</title>
    <style>
      /* Your existing CSS styles here (unchanged) */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: sans-serif;
        position: relative;
      }

      .home-button {
        display: inline-block;
        padding: 10px 20px;
        background-color: purple;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        font-weight: bold;
        font-size: 16px;
        margin-top: 10px;
      }

      .home-container {
        position: absolute;
        top: 10px;
        right: 20px;
        z-index: 10;
      }

      .dropdown,
      .form-group {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
      }

      .dropdown select,
      .dropdown .dropbtn {
        width: 100%;
        padding: 10px 20px;
        font-size: 16px;
        border-radius: 5px;
      }

      .dropdown-content {
        display: none;
        position: absolute;
        background-color: white;
        min-width: 160px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        z-index: 1;
        border-radius: 5px;
        overflow: hidden;
      }

      .dropdown-content a {
        color: black;
        padding: 10px 15px;
        text-decoration: none;
        display: block;
      }

      .dropdown-content a:hover {
        background-color: #f1f1f1;
      }

      .dropdown:hover .dropdown-content {
        display: block;
      }

      .background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        background: url("images/ubreakifix_cover.jpg") no-repeat center center;
        background-size: cover;
        opacity: 0.5;
      }

      .content {
        padding: 20px;
        margin-top: 10px;
      }

      label {
        margin-bottom: 5px;
      }

      input[type="text"],
      input[type="file"],
      input[type="number"],
      select,
      textarea {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        margin-top: 5px;
        border-radius: 5px;
        box-sizing: border-box;
      }

      input[type="text"]:focus,
      input[type="number"]:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border: 2px solid purple;
      }

      .form-group label {
        margin-bottom: 10px;
      }

      .textarea-container textarea {
        resize: vertical;
      }

      /* Image preview styling */
      .preview img {
        max-width: 100%;
        max-height: 150px;
        margin-top: 5px;
        border-radius: 5px;
        object-fit: cover;
      }

      /* Responsive Layout */
      @media (max-width: 600px) {
        .content {
          padding: 15px;
        }

        .dropbtn {
          width: 100%;
          text-align: left;
        }

        .dropdown-content {
          min-width: 100%;
        }

        .home-container {
          top: 5px;
          right: 5px;
        }
      }
    </style>
  </head>
  <body>
    <div class="background"></div>

    <div class="content">
      <div class="home-container">
        <a href="index.html" class="home-button">Home</a>
      </div>

      <h2 class="username">EOD Entry</h2>

      <!-- Van selection -->
      <section class="form-group">
        <label for="vanSelect"><strong>Select Van:</strong></label>
        <select id="vanSelect" onchange="showFuelDropdown()">
          <option value="">-- Choose a Van --</option>
          <option value="ram1">Ram Van 1</option>
          <option value="ram2">Ram Van 2</option>
        </select>
      </section>

      <!-- Fuel Level -->
      <section id="fuelDropdown" style="display: none" class="form-group">
        <label for="fuelLevel"><strong>Fuel Level:</strong></label>
        <select id="fuelLevel">
          <option value="">-- Select Fuel Level --</option>
          <option value="empty">Empty</option>
          <option value="1/8">1/8 Tank</option>
          <option value="1/4">1/4 Tank</option>
          <option value="3/8">3/8 Tank</option>
          <option value="1/2">1/2 Tank</option>
          <option value="5/8">5/8 Tank</option>
          <option value="3/4">3/4 Tank</option>
          <option value="7/8">7/8 Tank</option>
          <option value="full">Full Tank</option>
        </select>
      </section>

      <!-- Completed Jobs -->
      <section class="form-group">
        <label for="jobsCompleted"
          ><strong>Completed Jobs (e.g., 7/9):</strong></label
        >
        <input
          type="text"
          id="jobsCompleted"
          placeholder="X/X"
          oninput="checkCompletion()"
        />
      </section>

      <!-- Notes (only if not all jobs done) -->
      <section id="notesContainer" style="display: none" class="form-group">
        <label for="jobNotes"
          ><strong>Notes for incomplete jobs:</strong></label
        >
        <textarea
          id="jobNotes"
          rows="4"
          placeholder="Describe the issues here..."
        ></textarea>
      </section>

      <!-- Image Uploads -->
      <section class="form-group">
        <label><strong>Upload Images:</strong></label>
        <div style="display: flex; flex-wrap: wrap; gap: 15px">
          <div>
            <label>Front of the Van</label>
            <input type="file" accept="image/*" class="image-input" />
            <div class="preview"></div>
          </div>
          <div>
            <label>Left Side of the Van</label>
            <input type="file" accept="image/*" class="image-input" />
            <div class="preview"></div>
          </div>
          <div>
            <label>Back of the Van</label>
            <input type="file" accept="image/*" class="image-input" />
            <div class="preview"></div>
          </div>
          <div>
            <label>Right Side of the Van</label>
            <input type="file" accept="image/*" class="image-input" />
            <div class="preview"></div>
          </div>
          <div>
            <label>Work Area</label>
            <input type="file" accept="image/*" class="image-input" />
            <div class="preview"></div>
          </div>
          <div>
            <label>Parking Spot</label>
            <input type="file" accept="image/*" class="image-input" />
            <div class="preview"></div>
          </div>
        </div>
      </section>

      <!-- Service Checkbox Section -->
      <section class="form-group">
        <label
          ><input
            type="checkbox"
            id="serviceCheckbox"
            onchange="toggleServiceOptions()"
          />
          <strong>Service</strong></label
        >
      </section>

      <!-- Service Options -->
      <section
        id="serviceOptions"
        style="display: none; margin-left: 20px"
        class="form-group"
      >
        <label
          ><input type="checkbox" name="serviceItem" value="oil" /> Oil
          change</label
        ><br />
        <label
          ><input type="checkbox" name="serviceItem" value="fluids" /> All
          fluids changed</label
        ><br />
        <label
          ><input type="checkbox" name="serviceItem" value="tires" /> Tires
          changed</label
        ><br />
        <label
          ><input type="checkbox" name="serviceItem" value="headlight" />
          Headlight fluid changed</label
        ><br />
        <label
          ><input
            type="checkbox"
            id="otherServiceCheckbox"
            onchange="toggleOtherServiceNotes()"
          />
          Other service</label
        >

        <section
          id="otherServiceNotes"
          style="display: none"
          class="form-group"
        >
          <label for="serviceNotes"
            ><strong>Describe Other Service:</strong></label
          >
          <textarea
            id="serviceNotes"
            rows="4"
            placeholder="Enter details..."
          ></textarea>
        </section>
      </section>

      <!-- User Dropdown -->
      <section class="dropdown" style="margin-top: 30px; margin-bottom: 20px">
        <label><strong>User:</strong></label>
        <select
          id="userSelect"
          style="
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            width: 100%;
          "
        >
          <option value="">-- Select User --</option>
          <option value="Angelo">Angelo</option>
          <option value="Blake">Blake</option>
          <option value="Jacob">Jacob</option>
          <option value="Jesse">Jesse</option>
          <option value="Taylor">Taylor</option>
        </select>
      </section>

      <button
        id="saveEntryBtn"
        style="
          padding: 15px 30px;
          font-size: 18px;
          background-color: purple;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
        "
      >
        Save Entry
      </button>

      <div id="statusMessage" style="margin-top: 20px; font-weight: bold"></div>
    </div>

    <!-- Firebase SDK and Initialization (replace with your config) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

    <script>
      // Your Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAqSsrM59dxLgl-dm6OJGuDW32EaDdqMjs",
        authDomain: "eod-tracker.firebaseapp.com",
        projectId: "eod-tracker",
        storageBucket: "eod-tracker.firebasestorage.app",
        messagingSenderId: "642820935153",
        appId: "1:642820935153:web:8b23d0f430ad07e9680850",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const storage = firebase.storage();

      // Show/hide fuel dropdown
      function showFuelDropdown() {
        const van = document.getElementById("vanSelect").value;
        document.getElementById("fuelDropdown").style.display = van
          ? "block"
          : "none";
      }

      // Check completion to toggle notes
      function checkCompletion() {
        const val = document.getElementById("jobsCompleted").value;
        const notes = document.getElementById("notesContainer");
        const regex = /^(\d+)\s*\/\s*(\d+)$/;
        const match = val.match(regex);

        if (match) {
          const completed = parseInt(match[1]);
          const total = parseInt(match[2]);
          notes.style.display = completed < total ? "block" : "none";
        } else {
          notes.style.display = "none";
        }
      }

      // Toggle service options visibility
      function toggleServiceOptions() {
        const serviceChecked =
          document.getElementById("serviceCheckbox").checked;
        document.getElementById("serviceOptions").style.display = serviceChecked
          ? "block"
          : "none";

        if (!serviceChecked) {
          document.getElementById("otherServiceCheckbox").checked = false;
          document.getElementById("otherServiceNotes").style.display = "none";
        }
      }

      // Toggle other service notes visibility
      function toggleOtherServiceNotes() {
        const otherChecked = document.getElementById(
          "otherServiceCheckbox"
        ).checked;
        document.getElementById("otherServiceNotes").style.display =
          otherChecked ? "block" : "none";
      }

      // Image preview logic
      document.addEventListener("DOMContentLoaded", function () {
        const imageInputs = document.querySelectorAll(".image-input");

        imageInputs.forEach((input) => {
          input.addEventListener("change", function () {
            const file = this.files[0];
            const previewContainer = this.nextElementSibling;
            previewContainer.innerHTML = "";

            if (file && file.type.startsWith("image/")) {
              const reader = new FileReader();
              reader.onload = function (e) {
                const img = document.createElement("img");
                img.src = e.target.result;
                previewContainer.appendChild(img);
              };
              reader.readAsDataURL(file);
            }
          });
        });
      });

      // Save entry button handler
      document
        .getElementById("saveEntryBtn")
        .addEventListener("click", async () => {
          const user = document.getElementById("userSelect").value;
          if (!user) {
            alert("Please select a user.");
            return;
          }

          // Collect data
          const van = document.getElementById("vanSelect").value;
          const fuelLevel = document.getElementById("fuelLevel").value;
          const jobsCompleted = document.getElementById("jobsCompleted").value;
          const jobNotes = document.getElementById("jobNotes").value;
          const serviceChecked =
            document.getElementById("serviceCheckbox").checked;
          const serviceItems = Array.from(
            document.querySelectorAll('input[name="serviceItem"]:checked')
          ).map((el) => el.value);
          const otherServiceNotes =
            document.getElementById("serviceNotes").value;

          // Validate required fields
          if (!van) {
            alert("Please select a van.");
            return;
          }
          if (!fuelLevel) {
            alert("Please select a fuel level.");
            return;
          }

          // Get images from inputs
          const imageInputs = document.querySelectorAll(".image-input");
          const imageFiles = [];
          imageInputs.forEach((input) => {
            if (input.files[0]) imageFiles.push(input.files[0]);
            else imageFiles.push(null);
          });

          // Show saving status
          const statusMsg = document.getElementById("statusMessage");
          statusMsg.textContent = "Saving entry...";

          try {
            // Upload images and get URLs
            const imageURLs = [];
            for (let i = 0; i < imageFiles.length; i++) {
              if (imageFiles[i]) {
                const storageRef = storage
                  .ref()
                  .child(
                    `eod_images/${user}_${Date.now()}_${i}_${
                      imageFiles[i].name
                    }`
                  );
                await storageRef.put(imageFiles[i]);
                const url = await storageRef.getDownloadURL();
                imageURLs.push(url);
              } else {
                imageURLs.push(null);
              }
            }

            // Compose data object
            const entryData = {
              user,
              van,
              fuelLevel,
              jobsCompleted,
              jobNotes,
              serviceChecked,
              serviceItems,
              otherServiceNotes,
              imageURLs,
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            };

            // Save to Firestore
            await db.collection("eod_entries").add(entryData);

            statusMsg.textContent = "Entry saved successfully!";
            // Optionally reset form here if you want
            // document.querySelector("form").reset();
          } catch (error) {
            console.error("Error saving entry: ", error);
            statusMsg.textContent =
              "Failed to save entry. See console for details.";
          }
        });
    </script>
  </body>
</html>
