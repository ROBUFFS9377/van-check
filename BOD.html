<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BOD Page</title>
    <style>
      .home-container {
        position: absolute;
        top: 10px;
        right: 20px;
        z-index: 10;
      }

      .home-button,
      .dropbtn {
        display: inline-block;
        padding: 10px 20px;
        background-color: purple;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        font-weight: bold;
        font-size: 16px;
        margin-top: 10px;
        border: none;
        cursor: pointer;
      }

      body {
        margin: 0;
        padding: 0;
        position: relative;
        font-family: sans-serif;
      }

      .dropdown {
        position: relative;
        display: inline-block;
        margin-top: 10px;
      }

      .dropdown-content {
        display: none;
        position: absolute;
        background-color: white;
        min-width: 160px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        z-index: 1;
        border-radius: 5px;
        overflow: hidden;
      }

      .dropdown-content a {
        color: black;
        padding: 10px 15px;
        text-decoration: none;
        display: block;
      }

      .dropdown-content a:hover {
        background-color: #f1f1f1;
      }

      .dropdown:hover .dropdown-content {
        display: block;
      }

      .dropdown:hover .dropbtn {
        background-color: #800080;
      }

      .background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        background: url("images/ubreakifix_cover.jpg") no-repeat center center;
        background-size: cover;
        opacity: 0.5;
      }

      .content {
        position: relative;
        padding: 20px;
      }

      .username {
        font-weight: bold;
      }

      button {
        padding: 10px 15px;
        background-color: #6a0dad;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
      }

      input[type="number"],
      input[type="file"],
      textarea,
      select {
        padding: 8px;
        font-size: 16px;
        margin-top: 5px;
        border-radius: 5px;
        border: 1px solid #ccc;
      }

      #fuelDropdown,
      #issueNotesContainer,
      #imageUploadContainer {
        margin-top: 10px;
        display: none;
      }

      #previewContainer img {
        max-width: 100px;
        max-height: 100px;
        margin-top: 10px;
        margin-right: 10px;
        border-radius: 5px;
        object-fit: cover;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }

      @media (max-width: 600px) {
        .dropbtn {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <div class="background"></div>

    <div class="content">
      <!-- Home Button -->
      <div class="home-container">
        <a href="index.html" class="home-button">Home</a>
      </div>

      <p class="username">BOD ENTRY</p>

      <!-- Van Selection -->
      <div style="margin-top: 20px">
        <label for="vanSelect"><strong>Select Van:</strong></label>
        <select id="vanSelect" onchange="showFuelDropdown()">
          <option value="">-- Choose a Van --</option>
          <option value="ram1">Ram Van 1</option>
          <option value="ram2">Ram Van 2</option>
        </select>
      </div>

      <!-- Fuel Dropdown -->
      <div id="fuelDropdown">
        <label for="fuelLevel"><strong>Fuel Level:</strong></label>
        <select id="fuelLevel">
          <option value="">-- Select Fuel Level --</option>
          <option value="empty">Empty</option>
          <option value="1/8">1/8 Tank</option>
          <option value="1/4">1/4 Tank</option>
          <option value="3/8">3/8 Tank</option>
          <option value="1/2">1/2 Tank</option>
          <option value="5/8">5/8 Tank</option>
          <option value="3/4">3/4 Tank</option>
          <option value="7/8">7/8 Tank</option>
          <option value="full">Full Tank</option>
        </select>
      </div>

      <!-- Issues Found -->
      <div style="margin-top: 20px">
        <label>
          <input
            type="checkbox"
            id="issuesCheckbox"
            onchange="toggleIssues()"
          />
          <strong>Issues Found</strong>
        </label>
      </div>

      <!-- Notes Section -->
      <div id="issueNotesContainer">
        <label for="issueNotes"><strong>Notes about the issue:</strong></label
        ><br />
        <textarea
          id="issueNotes"
          rows="4"
          placeholder="Describe the issue..."
        ></textarea>
      </div>

      <!-- Image Upload Section -->
      <div id="imageUploadContainer">
        <label for="issueImages">Upload Images of the Issue:</label><br />
        <input type="file" id="issueImages" accept="image/*" multiple />
        <div
          id="previewContainer"
          style="display: flex; flex-wrap: wrap; gap: 10px"
        ></div>
      </div>

      <!-- User Dropdown -->
      <div class="dropdown" style="margin-top: 20px">
        <button class="dropbtn" id="userDropdownBtn">Select User</button>
        <div class="dropdown-content" id="userDropdownContent">
          <a href="#" onclick="selectUser('Angelo')">Angelo</a>
          <a href="#" onclick="selectUser('Blake')">Blake</a>
          <a href="#" onclick="selectUser('Jacob')">Jacob</a>
          <a href="#" onclick="selectUser('Jesse')">Jesse</a>
          <a href="#" onclick="selectUser('Taylor')">Taylor</a>
        </div>
      </div>

      <!-- Submit Button -->
      <button id="submitBtn" style="display: block; margin-top: 30px">
        Submit BOD Entry
      </button>

      <!-- Status Message -->
      <p id="statusMessage" style="margin-top: 20px; font-weight: bold"></p>
    </div>

    <!-- Firebase SDKs from CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-storage-compat.js"></script>

    <script>
      // Firebase config and initialization
      const firebaseConfig = {
        apiKey: "AIzaSyAqSsrM59dxLgl-dm6OJGuDW32EaDdqMjs",
        authDomain: "eod-tracker.firebaseapp.com",
        projectId: "eod-tracker",
        storageBucket: "eod-tracker.firebasestorage.app",
        messagingSenderId: "642820935153",
        appId: "1:642820935153:web:8b23d0f430ad07e9680850",
      };

      firebase.initializeApp(firebaseConfig);

      const db = firebase.firestore();
      const storage = firebase.storage();

      // UI control functions
      function showFuelDropdown() {
        const van = document.getElementById("vanSelect").value;
        document.getElementById("fuelDropdown").style.display = van
          ? "block"
          : "none";
      }

      function toggleIssues() {
        const isChecked = document.getElementById("issuesCheckbox").checked;
        document.getElementById("issueNotesContainer").style.display = isChecked
          ? "block"
          : "none";
        document.getElementById("imageUploadContainer").style.display =
          isChecked ? "block" : "none";
      }

      // Image preview logic
      document
        .getElementById("issueImages")
        .addEventListener("change", function () {
          const previewContainer = document.getElementById("previewContainer");
          previewContainer.innerHTML = "";
          const files = this.files;

          Array.from(files).forEach((file) => {
            if (file.type.startsWith("image/")) {
              const reader = new FileReader();
              reader.onload = function (e) {
                const img = document.createElement("img");
                img.src = e.target.result;
                previewContainer.appendChild(img);
              };
              reader.readAsDataURL(file);
            }
          });
        });

      // User dropdown selection
      let selectedUser = null;

      function selectUser(name) {
        selectedUser = name;
        document.getElementById("userDropdownBtn").textContent = name;
        // close dropdown after selection
        document.getElementById("userDropdownContent").style.display = "none";
      }

      // Toggle dropdown display on button click
      document
        .getElementById("userDropdownBtn")
        .addEventListener("click", function (e) {
          e.stopPropagation();
          const content = document.getElementById("userDropdownContent");
          content.style.display =
            content.style.display === "block" ? "none" : "block";
        });

      // Close dropdown if clicked outside
      window.addEventListener("click", function () {
        document.getElementById("userDropdownContent").style.display = "none";
      });

      // Submit handler
      document
        .getElementById("submitBtn")
        .addEventListener("click", async () => {
          const statusMessage = document.getElementById("statusMessage");
          statusMessage.textContent = "";

          // Validate inputs
          const van = document.getElementById("vanSelect").value;
          if (!van) {
            statusMessage.textContent = "Please select a van.";
            return;
          }

          const fuelLevel = document.getElementById("fuelLevel").value;
          if (!fuelLevel) {
            statusMessage.textContent = "Please select a fuel level.";
            return;
          }

          if (!selectedUser) {
            statusMessage.textContent = "Please select a user.";
            return;
          }

          const issuesFound = document.getElementById("issuesCheckbox").checked;
          const issueNotes = document.getElementById("issueNotes").value.trim();
          const issueImagesInput = document.getElementById("issueImages");
          const issueImagesFiles = Array.from(issueImagesInput.files);

          try {
            statusMessage.textContent = "Uploading images (if any)...";

            // Upload images to Firebase Storage and get URLs
            const imageUrls = [];
            for (const file of issueImagesFiles) {
              const storageRef = storage
                .ref()
                .child(`issueImages/${van}/${Date.now()}_${file.name}`);
              const snapshot = await storageRef.put(file);
              const url = await snapshot.ref.getDownloadURL();
              imageUrls.push(url);
            }

            statusMessage.textContent = "Saving report data...";

            // Prepare data object
            const reportData = {
              date: new Date().toISOString(),
              user: selectedUser,
              van: van,
              fuelLevel: fuelLevel,
              issuesFound: issuesFound,
              issueNotes: issueNotes,
              issueImages: imageUrls,
            };

            // Save to Firestore
            await db.collection("bodReports").add(reportData);

            statusMessage.style.color = "green";
            statusMessage.textContent = "BOD entry submitted successfully!";

            // Clear form for next entry
            resetForm();
          } catch (error) {
            console.error("Error submitting BOD entry:", error);
            statusMessage.style.color = "red";
            statusMessage.textContent =
              "Error submitting entry. Please try again.";
          }
        });

      function resetForm() {
        document.getElementById("vanSelect").value = "";
        document.getElementById("fuelDropdown").style.display = "none";
        document.getElementById("fuelLevel").value = "";
        document.getElementById("issuesCheckbox").checked = false;
        toggleIssues();
        document.getElementById("issueNotes").value = "";
        document.getElementById("issueImages").value = "";
        document.getElementById("previewContainer").innerHTML = "";
        selectedUser = null;
        document.getElementById("userDropdownBtn").textContent = "Select User";
        document.getElementById("statusMessage").style.color = "black";
      }
    </script>
  </body>
</html>
